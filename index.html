<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rapport Financier Mensuel</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF & html2canvas for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <style>
    /* Fix for printed backgrounds */
    @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <div class="bg-white shadow-xl rounded-2xl p-6" id="reportRoot">
      <div class="flex items-center justify-between gap-4 mb-6">
        <h1 class="text-2xl md:text-3xl font-bold">üìë Rapport Financier Mensuel</h1>
        <div class="flex gap-2">
          <button id="btnReset" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">R√©initialiser</button>
          <button id="btnPDF" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">G√©n√©rer le PDF</button>
        </div>
      </div>

      <!-- En-t√™te infos -->
      <div class="grid md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Centre</label>
          <input id="centre" class="w-full border rounded-xl p-2" placeholder="Nom du Centre" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">P√©riode</label>
          <input id="periode" class="w-full border rounded-xl p-2" placeholder="Ex : Juillet 2025" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Pr√©par√© par</label>
          <input id="preparePar" class="w-full border rounded-xl p-2" placeholder="Nom du comptable" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Approuv√© par</label>
          <input id="approuvePar" class="w-full border rounded-xl p-2" placeholder="Directeur r√©gional" />
        </div>
      </div>

      <!-- RECETTES -->
      <section class="mb-8">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold">Recettes</h2>
          <div class="flex gap-2">
            <button id="addRecette" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">+ Ajouter une ligne</button>
            <button id="importRecettes" class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">Coller depuis Excel</button>
          </div>
        </div>
        <div class="overflow-x-auto rounded-xl border">
          <table class="min-w-full" id="tableRecettes">
            <thead class="bg-emerald-600 text-white">
              <tr>
                <th class="p-2 text-left">N¬∞ de compte</th>
                <th class="p-2 text-left">Intitul√©</th>
                <th class="p-2 text-right">Montant (FCFA)</th>
                <th class="p-2 text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="tbodyRecettes" class="align-top"></tbody>
            <tfoot>
              <tr class="bg-emerald-50 font-semibold">
                <td class="p-2" colspan="2">Total Recettes</td>
                <td class="p-2 text-right" id="totalRecettes">0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- DEPENSES -->
      <section class="mb-8">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold">D√©penses</h2>
          <div class="flex gap-2">
            <button id="addDepense" class="px-3 py-1.5 rounded-lg bg-rose-600 text-white hover:bg-rose-700">+ Ajouter une ligne</button>
            <button id="importDepenses" class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200">Coller depuis Excel</button>
          </div>
        </div>
        <div class="overflow-x-auto rounded-xl border">
          <table class="min-w-full" id="tableDepenses">
            <thead class="bg-rose-600 text-white">
              <tr>
                <th class="p-2 text-left">N¬∞ de compte</th>
                <th class="p-2 text-left">Intitul√©</th>
                <th class="p-2 text-right">Montant (FCFA)</th>
                <th class="p-2 text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="tbodyDepenses" class="align-top"></tbody>
            <tfoot>
              <tr class="bg-rose-50 font-semibold">
                <td class="p-2" colspan="2">Total D√©penses</td>
                <td class="p-2 text-right" id="totalDepenses">0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- R√©sultat -->
      <section class="mb-8 grid md:grid-cols-2 gap-4">
        <div class="bg-green-50 rounded-2xl p-4 border">
          <div class="flex items-center justify-between">
            <span class="text-lg font-semibold">R√©sultat du mois</span>
            <span id="resultatBadge" class="text-sm px-2 py-1 rounded-full bg-gray-100">‚Äî</span>
          </div>
          <p class="text-2xl mt-2 font-bold" id="resultat">0</p>
        </div>

        <!-- Tr√©sorerie -->
        <div class="bg-indigo-50 rounded-2xl p-4 border">
          <h3 class="text-lg font-semibold mb-2">Tr√©sorerie</h3>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm">Solde caisse d√©but
              <input type="number" id="caisseDebut" class="w-full border rounded-xl p-2 mt-1" value="0" />
            </label>
            <label class="text-sm">Solde banque d√©but
              <input type="number" id="banqueDebut" class="w-full border rounded-xl p-2 mt-1" value="0" />
            </label>
            <label class="text-sm">Versements en banque
              <input type="number" id="versements" class="w-full border rounded-xl p-2 mt-1" value="0" />
            </label>
            <label class="text-sm">Retraits en banque
              <input type="number" id="retraits" class="w-full border rounded-xl p-2 mt-1" value="0" />
            </label>
            <label class="text-sm">Solde caisse fin
              <input type="number" id="caisseFin" class="w-full border rounded-xl p-2 mt-1" value="0" />
            </label>
            <label class="text-sm">Solde banque fin
              <input type="number" id="banqueFin" class="w-full border rounded-xl p-2 mt-1" value="0" />
            </label>
          </div>
          <div class="mt-3 text-right">
            <span class="text-sm font-medium">Tr√©sorerie totale</span>
            <div id="tresorerieTotale" class="text-xl font-bold">0</div>
          </div>
        </div>
      </section>

      <!-- Pied de rapport -->
      <div class="grid md:grid-cols-2 gap-4 mt-6">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Observations / Commentaires</label>
          <textarea id="observations" class="w-full border rounded-xl p-3 min-h-[100px]" placeholder="Justifications, difficult√©s, recommandations‚Ä¶"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Signature du Gestionnaire</label>
            <input id="signGestionnaire" class="w-full border rounded-xl p-2" placeholder="Nom et signature" />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Visa du Directeur R√©gional</label>
            <input id="visaDR" class="w-full border rounded-xl p-2" placeholder="Nom et visa" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Utilities
    const fmt = new Intl.NumberFormat('fr-FR');
    const parseNum = (v) => Number(v || 0);

    function moneyCell(value = 0) {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '1';
      input.value = value;
      input.className = 'w-full text-right border rounded-lg p-2 montant';
      input.addEventListener('input', recalcAll);
      return input;
    }

    function textCell(ph = '') {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = ph;
      input.className = 'w-full border rounded-lg p-2';
      return input;
    }

    function removeRow(btn) {
      const tr = btn.closest('tr');
      tr?.remove();
      recalcAll();
    }

    function rowTemplate({compte = '', libelle = '', montant = 0} = {}) {
      const tr = document.createElement('tr');
      tr.className = 'odd:bg-white even:bg-gray-50';

      const tdCpt = document.createElement('td');
      tdCpt.className = 'p-2';
      const inpCpt = textCell('N¬∞ de compte');
      inpCpt.value = compte;
      tdCpt.appendChild(inpCpt);

      const tdLib = document.createElement('td');
      tdLib.className = 'p-2';
      const inpLib = textCell('Intitul√©');
      inpLib.value = libelle;
      tdLib.appendChild(inpLib);

      const tdAmt = document.createElement('td');
      tdAmt.className = 'p-2 text-right';
      const inpAmt = moneyCell(montant);
      tdAmt.appendChild(inpAmt);

      const tdAct = document.createElement('td');
      tdAct.className = 'p-2 text-center';
      const del = document.createElement('button');
      del.className = 'px-2 py-1 rounded bg-gray-100 hover:bg-gray-200';
      del.textContent = 'Supprimer';
      del.addEventListener('click', () => removeRow(del));
      tdAct.appendChild(del);

      tr.append(tdCpt, tdLib, tdAmt, tdAct);
      return tr;
    }

    function addRow(tbody, data) { tbody.appendChild(rowTemplate(data)); }

    function sumTable(tbody) {
      let total = 0;
      tbody.querySelectorAll('input.montant').forEach(inp => total += parseNum(inp.value));
      return total;
    }

    function recalcAll() {
      const totalR = sumTable(document.getElementById('tbodyRecettes'));
      const totalD = sumTable(document.getElementById('tbodyDepenses'));
      document.getElementById('totalRecettes').textContent = fmt.format(totalR);
      document.getElementById('totalDepenses').textContent = fmt.format(totalD);

      const solde = totalR - totalD;
      const resEl = document.getElementById('resultat');
      resEl.textContent = fmt.format(solde);

      const badge = document.getElementById('resultatBadge');
      badge.textContent = solde >= 0 ? 'Exc√©dent' : 'D√©ficit';
      badge.className = 'text-sm px-2 py-1 rounded-full ' + (solde >= 0 ? 'bg-green-100 text-green-700' : 'bg-rose-100 text-rose-700');

      // Treasury
      const caisseDebut = parseNum(document.getElementById('caisseDebut').value);
      const banqueDebut = parseNum(document.getElementById('banqueDebut').value);
      const versements = parseNum(document.getElementById('versements').value);
      const retraits = parseNum(document.getElementById('retraits').value);
      const caisseFin = parseNum(document.getElementById('caisseFin').value);
      const banqueFin = parseNum(document.getElementById('banqueFin').value);

      const tresoTotale = caisseFin + banqueFin;
      document.getElementById('tresorerieTotale').textContent = fmt.format(tresoTotale);
    }

    // Paste from Excel (simple TSV/CSV paste into a prompt)
    function pasteFromExcel(targetTbodyId) {
      const raw = prompt('Collez ici les lignes (colonnes: compte\tintitul√©\tmontant)');
      if (!raw) return;
      const tbody = document.getElementById(targetTbodyId);
      raw.split(/\n+/).forEach(line => {
        const parts = line.split(/\t|;|,/); // accept tab/semicolon/comma
        if (parts.length >= 3) {
          addRow(tbody, { compte: parts[0].trim(), libelle: parts[1].trim(), montant: parseNum(parts[2].replace(/\s/g, '')) });
        }
      });
      recalcAll();
    }

    // Initialize with a few default rows
    function initTables() {
      const rTbody = document.getElementById('tbodyRecettes');
      const dTbody = document.getElementById('tbodyDepenses');
      [
        {compte: '7011', libelle: 'Produits du Bar'},
        {compte: '7021', libelle: 'Restauration'},
        {compte: '70611', libelle: 'H√©bergements'},
        {compte: '70612', libelle: 'Location de salles'}
      ].forEach(row => addRow(rTbody, row));

      [
        {compte: '661', libelle: 'R√©mun√©rations du personnel'},
        {compte: '6641', libelle: 'Charges sociales'},
        {compte: '6043', libelle: "Produits d'entretien"},
        {compte: '6241', libelle: 'Entretien b√¢timent'}
      ].forEach(row => addRow(dTbody, row));

      recalcAll();
    }

    // Export PDF: capture the reportRoot as image and fit into A4 portrait
    async function exportPDF() {
      const root = document.getElementById('reportRoot');
      const canvas = await html2canvas(root, { scale: 2, backgroundColor: '#ffffff' });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // compute image size to fit page while keeping ratio
      const imgWidth = pageWidth - 20; // margins
      const imgHeight = canvas.height * imgWidth / canvas.width;

      let y = 10;
      if (imgHeight < pageHeight - 20) {
        pdf.addImage(imgData, 'PNG', 10, y, imgWidth, imgHeight, undefined, 'FAST');
      } else {
        // If content is taller than one page, add multiple slices
        let remainingHeight = imgHeight;
        let position = 0;
        const onePageHeightPx = canvas.width * (pageHeight - 20) / (pageWidth - 20);
        while (remainingHeight > 0) {
          const pageCanvas = document.createElement('canvas');
          pageCanvas.width = canvas.width;
          pageCanvas.height = Math.min(onePageHeightPx, remainingHeight);
          const ctx = pageCanvas.getContext('2d');
          ctx.drawImage(canvas, 0, position, canvas.width, pageCanvas.height, 0, 0, canvas.width, pageCanvas.height);
          const pageImgData = pageCanvas.toDataURL('image/png');
          if (position === 0) {
            pdf.addImage(pageImgData, 'PNG', 10, 10, imgWidth, (pageCanvas.height * imgWidth) / canvas.width, undefined, 'FAST');
          } else {
            pdf.addPage();
            pdf.addImage(pageImgData, 'PNG', 10, 10, imgWidth, (pageCanvas.height * imgWidth) / canvas.width, undefined, 'FAST');
          }
          remainingHeight -= pageCanvas.height;
          position += pageCanvas.height;
        }
      }

      const name = `Rapport_Financier_${(document.getElementById('centre').value || 'Centre')}_${(document.getElementById('periode').value || 'Periode')}.pdf`;
      pdf.save(name.replace(/\s+/g, '_'));
    }

    // Event bindings
    window.addEventListener('DOMContentLoaded', () => {
      initTables();

      document.getElementById('addRecette').addEventListener('click', () => addRow(document.getElementById('tbodyRecettes')));
      document.getElementById('addDepense').addEventListener('click', () => addRow(document.getElementById('tbodyDepenses')));

      document.getElementById('importRecettes').addEventListener('click', () => pasteFromExcel('tbodyRecettes'));
      document.getElementById('importDepenses').addEventListener('click', () => pasteFromExcel('tbodyDepenses'));

      ;['caisseDebut','banqueDebut','versements','retraits','caisseFin','banqueFin'].forEach(id => {
        document.getElementById(id).addEventListener('input', recalcAll);
      });

      document.getElementById('btnPDF').addEventListener('click', exportPDF);
      document.getElementById('btnReset').addEventListener('click', () => {
        if (!confirm('Effacer toutes les lignes et r√©initialiser le formulaire ?')) return;
        document.getElementById('tbodyRecettes').innerHTML = '';
        document.getElementById('tbodyDepenses').innerHTML = '';
        document.querySelectorAll('input').forEach(inp => { if (inp.type === 'number') inp.value = 0; else inp.value=''; });
        initTables();
      });
    });
  </script>
</body>
</html>
